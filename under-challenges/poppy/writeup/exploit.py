from pwn import *
import sys

from exploit_bot import *
from exploit_mcts import *
from exploit_game import *

host = sys.argv[1]
port = int(sys.argv[2])

r = remote(host, port)

r.recvuntil(b"Play in practice mode? [y/N]")

r.sendline(b"N")

searcher = mcts(
    timeLimit=1_500, # 1.5 seconds
)

while True:
    r.recvuntil(b"Board:\n")

    print('Reading board')
    board = r.recvuntil(b" 1 ")
    print('Got board')

    game = Game.from_board(board.decode('utf-8'))

    print(f'Parsed game:')
    game.print_board()

    best_move = searcher.search(
        initialState=State(game, game.current_player),
    )
    
    if best_move[0] == DROP:
        r.sendline(b"d")
    else:
        assert best_move[0] == POP
        r.sendline(b"p")
    
    r.recvuntil(b"Which column? [1-7]")
    r.sendline(str(best_move[1] + 1).encode())

    extra = r.recvuntil([b"Bot chose to ", b"of 3", b'Here is the flag'])
    print('Extra got', extra.decode())
    if b'Here is the flag' in extra:
        print('Flag:', r.recvline().decode())
        break
    print('---')

